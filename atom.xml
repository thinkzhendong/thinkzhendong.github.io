<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>东哥仔的技术博客</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2018-03-21T07:32:47.829Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Alan</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Django Celery 定时任务</title>
    <link href="http://yoursite.com/2018/03/21/title-%20Django%20Celery%20%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"/>
    <id>http://yoursite.com/2018/03/21/title- Django Celery 定时任务/</id>
    <published>2018-03-21T07:32:47.829Z</published>
    <updated>2018-03-21T07:32:47.829Z</updated>
    
    <content type="html"><![CDATA[<p>环境信息：</p><ol><li>python 3.6.2</li><li>Django 1.9.8</li><li>celery 4.1.0</li><li>django-celery-beat 1.1.1</li></ol><h1 id="准备工作-安装环境"><a href="#准备工作-安装环境" class="headerlink" title="准备工作 安装环境"></a>准备工作 安装环境</h1><p>安装 django-celery-beat 及进行配置</p><pre><code>1. pip install -U django-celery-beat如果项目中settings.py中设置了USE_TZ=False，那么建议使用源码安装，有一个bug需要修改源文件     的方式进行解决。随后在项目根目录，进行migrate：2. python manage.py migrate3. 配置 项目/项目配置文件夹/settings.py:    ...INSTALLED_APPS = (       ...,       &apos;django_celery_beat&apos;,)...CELERY_BEAT_SCHEDULER = &apos;django_celery_beat.schedulers.DatabaseScheduler&apos;</code></pre><p>Redis安装及启动：</p><ol><li>安装redis：<br>Mac上通过brew 进行安装</li><li><p>列表项</p><p>输入命令: brew install redis</p></li></ol><ol><li>启动redis：<br> sudo /usr/local/bin/redis-server</li><li>查看redis进程及端口：<br> ps aux|grep redis</li></ol><p>celery 安装<br>    pip install -U celery[redis]</p><h1 id="Django-集成celery："><a href="#Django-集成celery：" class="headerlink" title="Django 集成celery："></a>Django 集成celery：</h1><ul><li>项目名称/<ul><li>manage.py</li></ul></li><li>项目配置文件/<ul><li><strong>init</strong>.py</li><li>settings.py</li><li>urls.py</li><li>celery.py</li></ul></li><li>mails/  # 这是一个app<ul><li>models.py</li><li>views.py</li><li>tasks.py<h1 id="配置以下文件"><a href="#配置以下文件" class="headerlink" title="配置以下文件"></a>配置以下文件</h1></li></ul></li></ul><ol><li><p>项目下的celery.py<br> from <strong>future</strong> import absolute_import, unicode_literals<br> import os<br> import django<br> from celery import Celery<br> import datetime</p><p> os.environ.setdefault(‘DJANGO_SETTINGS_MODULE’,’项目.settings’)<br> django.setup()  # 如果 tasks 里边涉及对 model 的操作，则需要加上     django.setup()<br> app = Celery(‘项目名’)</p><p> app.now = datetime.datetime.now  # 不加这一行会报错<br> app.config_from_object(‘django.conf:settings’, namespace=’CELERY’)<br> app.autodiscover_tasks()  # 自动加载各个app下边的tasks.py</p></li><li><p>配置<strong>init</strong> 路径:项目/配置文件夹/__init<strong>.py:<br> from </strong>future<strong> import absolute_import, unicode_literals<br> from .celery import app as celery<em>app<br> \</em>_all</strong> = [‘celery_app’]</p></li><li><p>配置settings.py<br> CELERY_BROKER_URL = ‘redis://127.0.0.1:6379/0’  # 这里注意redis的端口</p></li><li><p>在tasks文件写入自己的使用逻辑</p><pre><code>from 定义的项目名称.celery import app    @app.task    def ceshi_celery():        Ceshi.objects.create(type=1, text=&apos;测试plan底下文件是否运行2&apos;)    另:        也可以使用 from celery import shared_task                @shared_task    以上为使用例子</code></pre></li><li> 将django-celery-beat新增的model，配置到后台：<br> 看django_celery_beat.model可以看到一共是有5个model，具体的功能可以看源码，也很容易懂，这里主要用的是IntervalSchedule、CrontabSchedule和PeriodicTask。因为这里用的是xadmin后台的框架，但后台框架不会影响定时任务的功能，就不赘述。<br>需要注意Task name字段，为任务的路径或者名字，如果按照上述步骤配置的话，Task name应为mails.tasks.do_something。如果使用了@shared_task(name=’new_task_name’)进行重命名，那么Task name应为new_task_name<br>另外，如果是带参的定时任务，可以通过Arguments、Keyword arguments进行传参。</li></ol><h1 id="接下来启动celery-在项目下运行"><a href="#接下来启动celery-在项目下运行" class="headerlink" title="接下来启动celery 在项目下运行:"></a>接下来启动celery 在项目下运行:</h1><pre><code>celery -A 定义的项目名称 worker -l infocelery -A 定义的项目名称 beat -l info</code></pre><p>参考：<br>    <a href="https://actmerce.github.io/2018/03/21/django-celery-beat-1/" target="_blank" rel="noopener">https://actmerce.github.io/2018/03/21/django-celery-beat-1/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;环境信息：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;python 3.6.2&lt;/li&gt;
&lt;li&gt;Django 1.9.8&lt;/li&gt;
&lt;li&gt;celery 4.1.0&lt;/li&gt;
&lt;li&gt;django-celery-beat 1.1.1&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&quot;准备工作-安装环
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2018/02/13/hello-world/"/>
    <id>http://yoursite.com/2018/02/13/hello-world/</id>
    <published>2018-02-13T07:15:54.648Z</published>
    <updated>2018-03-01T08:58:11.401Z</updated>
    
    <content type="html"><![CDATA[<p>我的技术博客</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;我的技术博客&lt;/p&gt;

      
    
    </summary>
    
    
  </entry>
  
</feed>
